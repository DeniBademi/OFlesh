import { MultiLingualData } from "../core/multilingual-data";
import { translateContainer } from "../core/translate-container";
import { translateConfigContainer } from "../core/translate-config-container";
import { getKeyName } from "../functions/get-key-name";
import { Observable, of, forkJoin } from 'rxjs';
import { map } from 'rxjs/operators';
import { replacer } from "../functions/replacer";
export class BaseResolver {
    constructor(baseConfig, httpClient) {
        this.baseConfig = baseConfig;
        this.httpClient = httpClient;
        this.cloneBaseConfig = Object.assign({}, baseConfig);
    }
    resolveGlobal(config, isGlobal = true) {
        if (isGlobal)
            translateContainer.set(config.instance, config.config);
        if ((isGlobal && !this.baseConfig.forNgxTranslate) || !isGlobal) {
            translateConfigContainer.globalTranslate = this.resolve(config);
            translateConfigContainer.globalTranslate.subscribe(t => {
                translateConfigContainer.globalTranslate = undefined;
            });
        }
    }
    resolve(config, languageCode = "", isRouteLanguageChanged = false) {
        let containerConfig = config;
        if ((containerConfig && this.cloneBaseConfig.isTest) || (containerConfig && !MultiLingualData.contains(getKeyName(containerConfig.config.translationName, languageCode || this.cloneBaseConfig.languageCode), languageCode || this.cloneBaseConfig.languageCode)) || (containerConfig && isRouteLanguageChanged)) {
            let lang = containerConfig.config.language || languageCode || this.cloneBaseConfig.languageCode;
            if (containerConfig.config.inlineTranslations && containerConfig.config.inlineTranslations[lang]) {
                return Observable.create((subcriber) => {
                    containerConfig.config.inlineTranslations[lang]().then(t => { subcriber.next(t.default); subcriber.complete(); });
                }).pipe(map(this.setData(lang, containerConfig).bind(this)));
            }
            else if (!translateConfigContainer.customLoader) {
                let url = this.getPath(containerConfig, languageCode);
                if (url)
                    return this.httpClient.get(url).pipe(map(this.setData(lang, containerConfig).bind(this)));
            }
            else {
                let translationObject = lang;
                if (config.config.translationName != "global")
                    translationObject = Object.assign(Object.assign({}, config.config), { filePath: this.getPath(containerConfig, languageCode), lang: lang });
                return translateConfigContainer.customLoader.getTranslation(translationObject).pipe(map(this.setData(lang, containerConfig).bind(this)));
            }
        }
        else if ((containerConfig && MultiLingualData.contains(getKeyName(containerConfig.config.translationName, languageCode || this.cloneBaseConfig.languageCode), languageCode || this.cloneBaseConfig.languageCode))) {
            let body = MultiLingualData.get(getKeyName(containerConfig.config.translationName, languageCode || this.cloneBaseConfig.languageCode));
            this.setTitle(body, containerConfig);
        }
        return of(true);
    }
    setTitle(body, containerConfig) {
        if (translateConfigContainer.activePageTranslationName == containerConfig.config.translationName)
            this.setPageTitle(body);
    }
    setData(languageCode, containerConfig) {
        return body => {
            let name = getKeyName(containerConfig.config.translationName, languageCode || this.cloneBaseConfig.languageCode, containerConfig.config.filePath);
            let data = body;
            if (translateConfigContainer.resolver)
                data = translateConfigContainer.resolver(name.replace("global_", "").replace("global", ""), data);
            MultiLingualData.addOrUpdate(name, data, containerConfig.config.translationName, this.cloneBaseConfig.languageCode);
            this.setTitle(body, containerConfig);
            setTimeout(() => { MultiLingualData.clearInActives(this.cloneBaseConfig); }, 10);
            return body;
        };
    }
    getPath(containerConfig, languageCode = "") {
        let url = '';
        let splitKeywords = ['{{', '}}'];
        languageCode = containerConfig.config.language || languageCode || this.cloneBaseConfig.languageCode;
        if (containerConfig.config.filePath || this.cloneBaseConfig.filePath) {
            if (containerConfig.config.filePath) {
                let text = replacer(splitKeywords, containerConfig.config.filePath, { "language-code": languageCode, "translation-name": containerConfig.config.translationName });
                url = `/${text}`;
            }
            else {
                let text = replacer(splitKeywords, this.cloneBaseConfig.filePath, { "language-code": languageCode, "translation-name": containerConfig.config.translationName });
                url = `/${text}`;
            }
        }
        return url;
    }
    resolveRoute(route) {
        if (route.component) {
            let isRouteLanguageChanged = route.params && route.params["languageCode"] && route.params["languageCode"] != this.cloneBaseConfig.languageCode;
            let containerConfig = translateContainer.get(route.component);
            if (isRouteLanguageChanged) {
                this.updateLanguageByParam(route);
                this.cloneBaseConfig.languageCode = route.params["languageCode"];
                translateConfigContainer.loading = true;
            }
            if (containerConfig) {
                if (containerConfig.config)
                    translateConfigContainer.activePageTranslationName = containerConfig.config.translationName;
                return this.resolveData(containerConfig, '', isRouteLanguageChanged);
            }
            else if (isRouteLanguageChanged && translateConfigContainer.ngxTranslate) {
                translateConfigContainer.ngxTranslate.use(route.params["languageCode"]);
                translateConfigContainer.loading = false;
            }
        }
        return of(true);
    }
    resolveData(containerConfig, languageCode, isRouteLanguageChanged = false) {
        let additionalContainerConfigs = translateContainer.additionalGet(containerConfig.instance);
        let observables = new Array();
        additionalContainerConfigs.forEach(config => {
            observables.push(this.resolve(config, languageCode, isRouteLanguageChanged));
        });
        observables.push(this.resolve(containerConfig, languageCode, isRouteLanguageChanged));
        return forkJoin(observables).pipe(map((response) => {
            this.baseConfig.languageCode = this.cloneBaseConfig.languageCode;
            translateConfigContainer.loading = false;
            if (isRouteLanguageChanged && translateConfigContainer.ngxTranslate)
                translateConfigContainer.ngxTranslate.use(this.baseConfig.languageCode);
            return true;
        }));
    }
    updateLanguageByParam(route) {
        if (route.params && route.params["languageCode"] && (!this.baseConfig.languageCode || this.baseConfig.languageCode !== route.params["languageCode"])) {
            setTimeout(() => this.languageChanged(route.params["languageCode"]), 10);
        }
    }
    languageChanged(languageCode, onComplete) {
        let keys = this.getKeys(this.baseConfig.languageCode);
        this.cloneBaseConfig.languageCode = languageCode;
        this.changeTranslation(keys, 0, onComplete);
    }
    resolveByName(name, languageCode = null) {
        let containerConfig = translateContainer.getByName(name);
        return this.resolve(containerConfig, languageCode);
    }
    fakeResolveByName(name, fakeData, resolve) {
    }
    getKeys(languageCode) {
        return MultiLingualData.getActiveKeys().map(key => {
            return key.replace(`_${languageCode}`, '');
        });
    }
    changeTranslation(keys, index, onComplete) {
        if (keys.length > index) {
            translateConfigContainer.loading = true;
            var baseResolver = new BaseResolver(this.cloneBaseConfig, this.httpClient);
            baseResolver.resolveByName(keys[index]).subscribe(x => {
                let nextIndex = index + 1;
                this.changeTranslation(keys, nextIndex, onComplete);
            });
        }
        else {
            translateConfigContainer.config.languageCode = this.cloneBaseConfig.languageCode;
            translateConfigContainer.loading = false;
            if (onComplete)
                onComplete();
        }
    }
    setPageTitle(body) {
        if (body && body["pageTitle"])
            document.title = body["pageTitle"];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1yZXNvbHZlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3RyYW5zbGF0ZS9yZXNvbHZlci9iYXNlLXJlc29sdmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzdELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBS2pFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBZ0IsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsTUFBTSxPQUFPLFlBQVk7SUFDckIsWUFBb0IsVUFBNkIsRUFBVSxVQUFzQjtRQUE3RCxlQUFVLEdBQVYsVUFBVSxDQUFtQjtRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDN0UsSUFBSSxDQUFDLGVBQWUscUJBQVEsVUFBVSxDQUFFLENBQUM7SUFDN0MsQ0FBQztJQU1ELGFBQWEsQ0FBQyxNQUFnQyxFQUFFLFdBQW9CLElBQUk7UUFDcEUsSUFBSSxRQUFRO1lBQ1Isa0JBQWtCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQzdELHdCQUF3QixDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFD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RCxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxFQUFFO1lBQ3JCLHdCQUF3QixDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDeEMsSUFBSSxZQUFZLEdBQUcsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDM0UsWUFBWSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2xELElBQUksU0FBUyxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ3hELENBQUMsQ0FBQyxDQUFDO1NBQ047YUFBTTtZQUNILHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUM7WUFDakYsd0JBQXdCLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztZQUN6QyxJQUFJLFVBQVU7Z0JBQ1YsVUFBVSxFQUFFLENBQUM7U0FDcEI7SUFDTCxDQUFDO0lBRU8sWUFBWSxDQUFDLElBQStCO1FBQ2hELElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDekIsUUFBUSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJhbnNsYXRlQ29udGFpbmVyQ29uZmlnIH0gZnJvbSBcIi4uL2ludGVyZmFjZS90cmFuc2xhdGUtY29udGFpbmVyLWNvbmZpZ1wiO1xyXG5pbXBvcnQgeyBNdWx0aUxpbmd1YWxEYXRhIH0gZnJvbSBcIi4uL2NvcmUvbXVsdGlsaW5ndWFsLWRhdGFcIjtcclxuaW1wb3J0IHsgdHJhbnNsYXRlQ29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvdHJhbnNsYXRlLWNvbnRhaW5lclwiO1xyXG5pbXBvcnQgeyBSeFRyYW5zbGF0ZUNvbmZpZyB9IGZyb20gXCIuLi9pbnRlcmZhY2UvcngtdHJhbnNsYXRlLWNvbmZpZ1wiO1xyXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xyXG5pbXBvcnQgeyBleHRyYWN0IH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9leHRyYWN0XCI7XHJcbmltcG9ydCB7IGdldFZhbHVlIH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9nZXQtdmFsdWVcIjtcclxuaW1wb3J0IHsgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvdHJhbnNsYXRlLWNvbmZpZy1jb250YWluZXJcIjtcclxuaW1wb3J0IHsgZ2V0S2V5TmFtZSB9IGZyb20gXCIuLi9mdW5jdGlvbnMvZ2V0LWtleS1uYW1lXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJzY3JpcHRpb24sIGZvcmtKb2luIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xyXG5pbXBvcnQgeyByZXBsYWNlciB9IGZyb20gXCIuLi9mdW5jdGlvbnMvcmVwbGFjZXJcIjtcclxuZXhwb3J0IGNsYXNzIEJhc2VSZXNvbHZlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJhc2VDb25maWc6IFJ4VHJhbnNsYXRlQ29uZmlnLCBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpIHtcclxuICAgICAgICB0aGlzLmNsb25lQmFzZUNvbmZpZyA9IHsgLi4uYmFzZUNvbmZpZyB9O1xyXG4gICAgfVxyXG4gICAgY2xvbmVCYXNlQ29uZmlnOiBSeFRyYW5zbGF0ZUNvbmZpZztcclxuICAgIHhocjogWE1MSHR0cFJlcXVlc3Q7XHJcbiAgICBjb250YWluZXJDb25maWc6IFRyYW5zbGF0ZUNvbnRhaW5lckNvbmZpZztcclxuICAgIGxvYWRFdmVudEZ1bmN0aW9uOiBhbnk7XHJcblxyXG4gICAgcmVzb2x2ZUdsb2JhbChjb25maWc6IFRyYW5zbGF0ZUNvbnRhaW5lckNvbmZpZywgaXNHbG9iYWw6IGJvb2xlYW4gPSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKGlzR2xvYmFsKVxyXG4gICAgICAgICAgICB0cmFuc2xhdGVDb250YWluZXIuc2V0KGNvbmZpZy5pbnN0YW5jZSwgY29uZmlnLmNvbmZpZyk7XHJcbiAgICAgICAgaWYgKChpc0dsb2JhbCAmJiAhdGhpcy5iYXNlQ29uZmlnLmZvck5neFRyYW5zbGF0ZSkgfHwgIWlzR2xvYmFsKSB7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5nbG9iYWxUcmFuc2xhdGUgPSB0aGlzLnJlc29sdmUoY29uZmlnKTtcclxuICAgICAgICAgICAgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmdsb2JhbFRyYW5zbGF0ZS5zdWJzY3JpYmUodCA9PiB7XHJcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGVDb25maWdDb250YWluZXIuZ2xvYmFsVHJhbnNsYXRlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVzb2x2ZShjb25maWc6IFRyYW5zbGF0ZUNvbnRhaW5lckNvbmZpZywgbGFuZ3VhZ2VDb2RlOiBzdHJpbmcgPSBcIlwiLCBpc1JvdXRlTGFuZ3VhZ2VDaGFuZ2VkOiBib29sZWFuID0gZmFsc2UpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgICAgICBsZXQgY29udGFpbmVyQ29uZmlnID0gY29uZmlnO1xyXG4gICAgICAgIGlmICgoY29udGFpbmVyQ29uZmlnICYmIHRoaXMuY2xvbmVCYXNlQ29uZmlnLmlzVGVzdCkgfHwgKGNvbnRhaW5lckNvbmZpZyAmJiAhTXVsdGlMaW5ndWFsRGF0YS5jb250YWlucyhnZXRLZXlOYW1lKGNvbnRhaW5lckNvbmZpZy5jb25maWcudHJhbnNsYXRpb25OYW1lLCBsYW5ndWFnZUNvZGUgfHwgdGhpcy5jbG9uZUJhc2VDb25maWcubGFuZ3VhZ2VDb2RlKSwgbGFuZ3VhZ2VDb2RlIHx8IHRoaXMuY2xvbmVCYXNlQ29uZmlnLmxhbmd1YWdlQ29kZSkpIHx8IChjb250YWluZXJDb25maWcgJiYgaXNSb3V0ZUxhbmd1YWdlQ2hhbmdlZCkpIHtcclxuICAgICAgICAgICAgbGV0IGxhbmc6IGFueSA9IGNvbnRhaW5lckNvbmZpZy5jb25maWcubGFuZ3VhZ2UgfHwgbGFuZ3VhZ2VDb2RlIHx8IHRoaXMuY2xvbmVCYXNlQ29uZmlnLmxhbmd1YWdlQ29kZTtcclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lckNvbmZpZy5jb25maWcuaW5saW5lVHJhbnNsYXRpb25zICYmIGNvbnRhaW5lckNvbmZpZy5jb25maWcuaW5saW5lVHJhbnNsYXRpb25zW2xhbmddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKHN1YmNyaWJlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lckNvbmZpZy5jb25maWcuaW5saW5lVHJhbnNsYXRpb25zW2xhbmddKCkudGhlbih0ID0+IHsgc3ViY3JpYmVyLm5leHQodC5kZWZhdWx0KTsgc3ViY3JpYmVyLmNvbXBsZXRlKCkgfSk7XHJcbiAgICAgICAgICAgICAgICB9KS5waXBlKG1hcCh0aGlzLnNldERhdGEobGFuZywgY29udGFpbmVyQ29uZmlnKS5iaW5kKHRoaXMpKSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICghdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmN1c3RvbUxvYWRlcikge1xyXG4gICAgICAgICAgICAgICAgbGV0IHVybCA9IHRoaXMuZ2V0UGF0aChjb250YWluZXJDb25maWcsIGxhbmd1YWdlQ29kZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodXJsKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybCkucGlwZShtYXAodGhpcy5zZXREYXRhKGxhbmcsIGNvbnRhaW5lckNvbmZpZykuYmluZCh0aGlzKSkpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRyYW5zbGF0aW9uT2JqZWN0ID0gbGFuZztcclxuICAgICAgICAgICAgICAgIGlmIChjb25maWcuY29uZmlnLnRyYW5zbGF0aW9uTmFtZSAhPSBcImdsb2JhbFwiKVxyXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0aW9uT2JqZWN0ID0geyAuLi5jb25maWcuY29uZmlnLCAuLi57IGZpbGVQYXRoOiB0aGlzLmdldFBhdGgoY29udGFpbmVyQ29uZmlnLCBsYW5ndWFnZUNvZGUpLCBsYW5nOiBsYW5nIH0gfTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2xhdGVDb25maWdDb250YWluZXIuY3VzdG9tTG9hZGVyLmdldFRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uT2JqZWN0KS5waXBlKG1hcCh0aGlzLnNldERhdGEobGFuZywgY29udGFpbmVyQ29uZmlnKS5iaW5kKHRoaXMpKSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICgoY29udGFpbmVyQ29uZmlnICYmIE11bHRpTGluZ3VhbERhdGEuY29udGFpbnMoZ2V0S2V5TmFtZShjb250YWluZXJDb25maWcuY29uZmlnLnRyYW5zbGF0aW9uTmFtZSwgbGFuZ3VhZ2VDb2RlIHx8IHRoaXMuY2xvbmVCYXNlQ29uZmlnLmxhbmd1YWdlQ29kZSksIGxhbmd1YWdlQ29kZSB8fCB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUpKSkge1xyXG4gICAgICAgICAgICBsZXQgYm9keSA9IE11bHRpTGluZ3VhbERhdGEuZ2V0KGdldEtleU5hbWUoY29udGFpbmVyQ29uZmlnLmNvbmZpZy50cmFuc2xhdGlvbk5hbWUsIGxhbmd1YWdlQ29kZSB8fCB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUpKVxyXG4gICAgICAgICAgICB0aGlzLnNldFRpdGxlKGJvZHksIGNvbnRhaW5lckNvbmZpZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2V0VGl0bGUoYm9keSwgY29udGFpbmVyQ29uZmlnOiBUcmFuc2xhdGVDb250YWluZXJDb25maWcpIHtcclxuICAgICAgICBpZiAodHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmFjdGl2ZVBhZ2VUcmFuc2xhdGlvbk5hbWUgPT0gY29udGFpbmVyQ29uZmlnLmNvbmZpZy50cmFuc2xhdGlvbk5hbWUpXHJcbiAgICAgICAgICAgIHRoaXMuc2V0UGFnZVRpdGxlKGJvZHkpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldERhdGEobGFuZ3VhZ2VDb2RlOiBzdHJpbmcsIGNvbnRhaW5lckNvbmZpZzogVHJhbnNsYXRlQ29udGFpbmVyQ29uZmlnKSB7XHJcbiAgICAgICAgcmV0dXJuIGJvZHkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgbmFtZSA9IGdldEtleU5hbWUoY29udGFpbmVyQ29uZmlnLmNvbmZpZy50cmFuc2xhdGlvbk5hbWUsIGxhbmd1YWdlQ29kZSB8fCB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUsIGNvbnRhaW5lckNvbmZpZy5jb25maWcuZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICBsZXQgZGF0YSA9IGJvZHk7XHJcbiAgICAgICAgICAgIGlmICh0cmFuc2xhdGVDb25maWdDb250YWluZXIucmVzb2x2ZXIpXHJcbiAgICAgICAgICAgICAgICBkYXRhID0gdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLnJlc29sdmVyKG5hbWUucmVwbGFjZShcImdsb2JhbF9cIiwgXCJcIikucmVwbGFjZShcImdsb2JhbFwiLCBcIlwiKSwgZGF0YSk7XHJcbiAgICAgICAgICAgIE11bHRpTGluZ3VhbERhdGEuYWRkT3JVcGRhdGUobmFtZSwgZGF0YSwgY29udGFpbmVyQ29uZmlnLmNvbmZpZy50cmFuc2xhdGlvbk5hbWUsIHRoaXMuY2xvbmVCYXNlQ29uZmlnLmxhbmd1YWdlQ29kZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0VGl0bGUoYm9keSwgY29udGFpbmVyQ29uZmlnKVxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgTXVsdGlMaW5ndWFsRGF0YS5jbGVhckluQWN0aXZlcyh0aGlzLmNsb25lQmFzZUNvbmZpZykgfSwgMTApO1xyXG4gICAgICAgICAgICByZXR1cm4gYm9keTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBnZXRQYXRoKGNvbnRhaW5lckNvbmZpZzogVHJhbnNsYXRlQ29udGFpbmVyQ29uZmlnLCBsYW5ndWFnZUNvZGU6IHN0cmluZyA9IFwiXCIpIHtcclxuICAgICAgICBsZXQgdXJsID0gJyc7XHJcbiAgICAgICAgbGV0IHNwbGl0S2V5d29yZHMgPSBbJ3t7JywgJ319J107XHJcbiAgICAgICAgbGFuZ3VhZ2VDb2RlID0gY29udGFpbmVyQ29uZmlnLmNvbmZpZy5sYW5ndWFnZSB8fCBsYW5ndWFnZUNvZGUgfHwgdGhpcy5jbG9uZUJhc2VDb25maWcubGFuZ3VhZ2VDb2RlO1xyXG4gICAgICAgIGlmIChjb250YWluZXJDb25maWcuY29uZmlnLmZpbGVQYXRoIHx8IHRoaXMuY2xvbmVCYXNlQ29uZmlnLmZpbGVQYXRoKSB7XHJcbiAgICAgICAgICAgIGlmIChjb250YWluZXJDb25maWcuY29uZmlnLmZpbGVQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdGV4dCA9IHJlcGxhY2VyKHNwbGl0S2V5d29yZHMsIGNvbnRhaW5lckNvbmZpZy5jb25maWcuZmlsZVBhdGgsIHsgXCJsYW5ndWFnZS1jb2RlXCI6IGxhbmd1YWdlQ29kZSwgXCJ0cmFuc2xhdGlvbi1uYW1lXCI6IGNvbnRhaW5lckNvbmZpZy5jb25maWcudHJhbnNsYXRpb25OYW1lIH0pXHJcbiAgICAgICAgICAgICAgICB1cmwgPSBgLyR7dGV4dH1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRleHQgPSByZXBsYWNlcihzcGxpdEtleXdvcmRzLCB0aGlzLmNsb25lQmFzZUNvbmZpZy5maWxlUGF0aCwgeyBcImxhbmd1YWdlLWNvZGVcIjogbGFuZ3VhZ2VDb2RlLCBcInRyYW5zbGF0aW9uLW5hbWVcIjogY29udGFpbmVyQ29uZmlnLmNvbmZpZy50cmFuc2xhdGlvbk5hbWUgfSlcclxuICAgICAgICAgICAgICAgIHVybCA9IGAvJHt0ZXh0fWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVybFxyXG4gICAgfVxyXG5cclxuICAgIHJlc29sdmVSb3V0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCkge1xyXG4gICAgICAgIGlmIChyb3V0ZS5jb21wb25lbnQpIHtcclxuICAgICAgICAgICAgbGV0IGlzUm91dGVMYW5ndWFnZUNoYW5nZWQgPSByb3V0ZS5wYXJhbXMgJiYgcm91dGUucGFyYW1zW1wibGFuZ3VhZ2VDb2RlXCJdICYmIHJvdXRlLnBhcmFtc1tcImxhbmd1YWdlQ29kZVwiXSAhPSB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGU7XHJcbiAgICAgICAgICAgIGxldCBjb250YWluZXJDb25maWcgPSB0cmFuc2xhdGVDb250YWluZXIuZ2V0KHJvdXRlLmNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGlmIChpc1JvdXRlTGFuZ3VhZ2VDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxhbmd1YWdlQnlQYXJhbShyb3V0ZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUgPSByb3V0ZS5wYXJhbXNbXCJsYW5ndWFnZUNvZGVcIl07XHJcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGVDb25maWdDb250YWluZXIubG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lckNvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lckNvbmZpZy5jb25maWcpXHJcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmFjdGl2ZVBhZ2VUcmFuc2xhdGlvbk5hbWUgPSBjb250YWluZXJDb25maWcuY29uZmlnLnRyYW5zbGF0aW9uTmFtZTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc29sdmVEYXRhKGNvbnRhaW5lckNvbmZpZywgJycsIGlzUm91dGVMYW5ndWFnZUNoYW5nZWQpXHJcbiAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICAgICAgaWYgKGlzUm91dGVMYW5ndWFnZUNoYW5nZWQgJiYgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLm5neFRyYW5zbGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5uZ3hUcmFuc2xhdGUudXNlKHJvdXRlLnBhcmFtc1tcImxhbmd1YWdlQ29kZVwiXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmxvYWRpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc29sdmVEYXRhKGNvbnRhaW5lckNvbmZpZzogVHJhbnNsYXRlQ29udGFpbmVyQ29uZmlnLCBsYW5ndWFnZUNvZGU6IHN0cmluZywgaXNSb3V0ZUxhbmd1YWdlQ2hhbmdlZDogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICAgICAgbGV0IGFkZGl0aW9uYWxDb250YWluZXJDb25maWdzID0gdHJhbnNsYXRlQ29udGFpbmVyLmFkZGl0aW9uYWxHZXQoY29udGFpbmVyQ29uZmlnLmluc3RhbmNlKTtcclxuICAgICAgICBsZXQgb2JzZXJ2YWJsZXMgPSBuZXcgQXJyYXk8T2JzZXJ2YWJsZTxhbnk+PigpO1xyXG4gICAgICAgIGFkZGl0aW9uYWxDb250YWluZXJDb25maWdzLmZvckVhY2goY29uZmlnID0+IHtcclxuICAgICAgICAgICAgb2JzZXJ2YWJsZXMucHVzaCh0aGlzLnJlc29sdmUoY29uZmlnLCBsYW5ndWFnZUNvZGUsIGlzUm91dGVMYW5ndWFnZUNoYW5nZWQpKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIG9ic2VydmFibGVzLnB1c2godGhpcy5yZXNvbHZlKGNvbnRhaW5lckNvbmZpZywgbGFuZ3VhZ2VDb2RlLCBpc1JvdXRlTGFuZ3VhZ2VDaGFuZ2VkKSlcclxuICAgICAgICByZXR1cm4gZm9ya0pvaW4ob2JzZXJ2YWJsZXMpLnBpcGUobWFwKChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuYmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUgPSB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGU7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChpc1JvdXRlTGFuZ3VhZ2VDaGFuZ2VkICYmIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5uZ3hUcmFuc2xhdGUpXHJcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGVDb25maWdDb250YWluZXIubmd4VHJhbnNsYXRlLnVzZSh0aGlzLmJhc2VDb25maWcubGFuZ3VhZ2VDb2RlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSkpXHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlTGFuZ3VhZ2VCeVBhcmFtKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KSB7XHJcbiAgICAgICAgaWYgKHJvdXRlLnBhcmFtcyAmJiByb3V0ZS5wYXJhbXNbXCJsYW5ndWFnZUNvZGVcIl0gJiYgKCF0aGlzLmJhc2VDb25maWcubGFuZ3VhZ2VDb2RlIHx8IHRoaXMuYmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUgIT09IHJvdXRlLnBhcmFtc1tcImxhbmd1YWdlQ29kZVwiXSkpIHtcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmxhbmd1YWdlQ2hhbmdlZChyb3V0ZS5wYXJhbXNbXCJsYW5ndWFnZUNvZGVcIl0pLCAxMClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGFuZ3VhZ2VDaGFuZ2VkKGxhbmd1YWdlQ29kZTogc3RyaW5nLCBvbkNvbXBsZXRlPzogRnVuY3Rpb24pIHtcclxuICAgICAgICBsZXQga2V5cyA9IHRoaXMuZ2V0S2V5cyh0aGlzLmJhc2VDb25maWcubGFuZ3VhZ2VDb2RlKTtcclxuICAgICAgICB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGUgPSBsYW5ndWFnZUNvZGU7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VUcmFuc2xhdGlvbihrZXlzLCAwLCBvbkNvbXBsZXRlKTtcclxuICAgIH1cclxuXHJcbiAgICByZXNvbHZlQnlOYW1lKG5hbWU6IHN0cmluZywgbGFuZ3VhZ2VDb2RlOiBzdHJpbmcgPSBudWxsKSB7XHJcbiAgICAgICAgbGV0IGNvbnRhaW5lckNvbmZpZyA9IHRyYW5zbGF0ZUNvbnRhaW5lci5nZXRCeU5hbWUobmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZShjb250YWluZXJDb25maWcsIGxhbmd1YWdlQ29kZSk7XHJcbiAgICB9XHJcbiAgICBmYWtlUmVzb2x2ZUJ5TmFtZShuYW1lOiBzdHJpbmcsIGZha2VEYXRhOiBhbnksIHJlc29sdmU6IEZ1bmN0aW9uKSB7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldEtleXMobGFuZ3VhZ2VDb2RlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gTXVsdGlMaW5ndWFsRGF0YS5nZXRBY3RpdmVLZXlzKCkubWFwKGtleSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBrZXkucmVwbGFjZShgXyR7bGFuZ3VhZ2VDb2RlfWAsICcnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoYW5nZVRyYW5zbGF0aW9uKGtleXMsIGluZGV4LCBvbkNvbXBsZXRlPzogRnVuY3Rpb24pIHtcclxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPiBpbmRleCkge1xyXG4gICAgICAgICAgICB0cmFuc2xhdGVDb25maWdDb250YWluZXIubG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgICAgIHZhciBiYXNlUmVzb2x2ZXIgPSBuZXcgQmFzZVJlc29sdmVyKHRoaXMuY2xvbmVCYXNlQ29uZmlnLCB0aGlzLmh0dHBDbGllbnQpO1xyXG4gICAgICAgICAgICBiYXNlUmVzb2x2ZXIucmVzb2x2ZUJ5TmFtZShrZXlzW2luZGV4XSkuc3Vic2NyaWJlKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IG5leHRJbmRleCA9IGluZGV4ICsgMTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlVHJhbnNsYXRpb24oa2V5cywgbmV4dEluZGV4LCBvbkNvbXBsZXRlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmNvbmZpZy5sYW5ndWFnZUNvZGUgPSB0aGlzLmNsb25lQmFzZUNvbmZpZy5sYW5ndWFnZUNvZGU7XHJcbiAgICAgICAgICAgIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5sb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChvbkNvbXBsZXRlKVxyXG4gICAgICAgICAgICAgICAgb25Db21wbGV0ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldFBhZ2VUaXRsZShib2R5OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9KSB7XHJcbiAgICAgICAgaWYgKGJvZHkgJiYgYm9keVtcInBhZ2VUaXRsZVwiXSlcclxuICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBib2R5W1wicGFnZVRpdGxlXCJdO1xyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=