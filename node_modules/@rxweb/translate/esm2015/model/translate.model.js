import { isObject } from "../functions/is-object";
import { extract } from "../functions/extract";
import { getValue } from "../functions/get-value";
import { translateConfigContainer } from "../core/translate-config-container";
import { equals } from "../functions/equals";
import { MultiLingualData } from "../core/multilingual-data";
import { getKeyName } from "../functions/get-key-name";
import { runPipe } from "../functions/pipe.transformer";
export class TranslateModel {
    constructor(raw, componentData, modelName, parentData) {
        this.raw = raw;
        this.componentData = componentData;
        this.modelName = modelName;
        this.parentData = parentData;
        this.keyParameters = {};
        this.memoized = {};
        this.thisParameter = {};
        let data = raw;
        if (data)
            Object.keys(data).forEach(key => {
                Object.defineProperty(this, key, {
                    get: function () {
                        let text = data[key];
                        if (isObject(text)) {
                            if (!(data[key] instanceof TranslateModel)) {
                                let pData = Object.keys(parentData).length == 0 ? data : parentData;
                                if (!translateConfigContainer.loading)
                                    text = data[key] = new TranslateModel(data[key], componentData, modelName, pData);
                                else
                                    return new TranslateModel(data[key], {}, modelName, pData);
                            }
                            else
                                text = data[key];
                            return text;
                        }
                        return translateConfigContainer.loading ? "loading..." : this.transform(data, key, text);
                    },
                    enumerable: true,
                    configurable: true
                });
            });
    }
    getKeyValue(keyParamObject) {
        let keyValue = {};
        Object.keys(keyParamObject).forEach(key => {
            keyValue[key] = getValue(key, this.componentData);
        });
        return keyValue;
    }
    transform(data, key, text) {
        if (this.thisParameter[key])
            return this.getText(data, text, key);
        if (this.keyParameters && this.keyParameters[key] && isObject(this.keyParameters[key])) {
            if (!equals(this.keyParameters[key], this.getKeyValue(this.keyParameters[key])))
                return this.getText(data, text, key);
            else if (this.memoized[key])
                return this.memoized[key];
        }
        if (this.keyParameters && !this.keyParameters[key])
            return this.getText(data, text, key);
        else
            return typeof text === "function" ? text() : text;
    }
    get languageCode() {
        return translateConfigContainer.config ? translateConfigContainer.config.languageCode : "en";
    }
    get(key) {
        let jObject;
        if (key) {
            var keys = key.split(".");
            for (let column of keys) {
                if (!jObject)
                    jObject = this[column];
                else
                    jObject = jObject[column];
            }
        }
        return jObject;
    }
    addOrUpdateKey(name, value) {
        let keyName = getKeyName(this.modelName, this.languageCode, undefined);
        let data = MultiLingualData.get(keyName);
        if (!isObject(value))
            data[name] = value;
        else if (data[name])
            data[name] = Object.assign(Object.assign({}, data[name]), value);
        else
            data[name] = value;
        MultiLingualData.addOrUpdate(keyName, data, this.languageCode);
        MultiLingualData.removeComponentPropValue(this.componentData.constructor, this.componentData["__ngContext__"].rxRefMarkedId, keyName);
    }
    ngxTranslateParser(translations, key) {
        return translateConfigContainer.ngxTranslate["getParsedResult"](translations, key, null);
    }
    getText(translations, text, columnKey) {
        text = translateConfigContainer.ngxTranslate ? this.ngxTranslateParser(translations, columnKey) : text;
        if (text.indexOf('this.') !== -1 || text.indexOf('{{{this') !== -1) {
            this.thisParameter[columnKey] = true;
            if (text.indexOf('{{{this') !== -1) {
                let stringExtractor = extract(['{{{', '}}}']);
                let keys = stringExtractor(text);
                keys.forEach(t => {
                    var func = new Function("x", "return " + t);
                    let calculatedText = func.call(this.componentData);
                    text = text.replace(`{{{${t}}}}`, calculatedText);
                });
            }
            else {
                var func = new Function("x", "return " + text);
                text = func.call(this.componentData);
            }
        }
        if (text && text.indexOf("{{") != -1) {
            let stringExtractor = extract(['{{', '}}']);
            let keys = stringExtractor(text);
            keys.forEach(key => {
                let value = runPipe(key, this.componentData, this.parentData);
                if (key == value) {
                    value = getValue(key, this.parentData);
                    if (!value)
                        value = getValue(key, this.componentData);
                }
                if (!this.keyParameters[columnKey])
                    this.keyParameters[columnKey] = {};
                this.keyParameters[columnKey][key] = value;
                text = text.replace(`{{${key}}}`, value);
            });
            this.memoized[columnKey] = text;
        }
        else
            this.keyParameters[columnKey] = true;
        return text;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvdHJhbnNsYXRlL21vZGVsL3RyYW5zbGF0ZS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUM5RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV4RCxNQUFNLE9BQU8sY0FBYztJQUN2QixZQUFtQixHQUEyQixFQUFVLGFBQWtCLEVBQVUsU0FBUyxFQUFVLFVBQVU7UUFBOUYsUUFBRyxHQUFILEdBQUcsQ0FBd0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBSztRQUFVLGNBQVMsR0FBVCxTQUFTLENBQUE7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFBO1FBbUR6RyxrQkFBYSxHQUEyQixFQUFFLENBQUM7UUFFM0MsYUFBUSxHQUE4QixFQUFFLENBQUM7UUFFekMsa0JBQWEsR0FBK0IsRUFBRSxDQUFDO1FBdERuRCxJQUFJLElBQUksR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLElBQUk7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDNUIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFO29CQUM3QixHQUFHLEVBQUU7d0JBQ0QsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUNyQixJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTs0QkFDaEIsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLGNBQWMsQ0FBQyxFQUFFO2dDQUN4QyxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO2dDQUNwRSxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTztvQ0FDakMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQzs7b0NBRWxGLE9BQU8sSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7NkJBQ2xFOztnQ0FDRyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUNyQixPQUFPLElBQUksQ0FBQzt5QkFDZjt3QkFDRCxPQUFPLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7b0JBQzVGLENBQUM7b0JBQ0QsVUFBVSxFQUFFLElBQUk7b0JBQ2hCLFlBQVksRUFBRSxJQUFJO2lCQUNyQixDQUFDLENBQUE7WUFDTixDQUFDLENBQUMsQ0FBQTtJQUNWLENBQUM7SUFFTyxXQUFXLENBQUMsY0FBbUI7UUFDbkMsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3RDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFTyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJO1FBQzdCLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUM7WUFDdkIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDekMsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNwRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzNFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2lCQUNwQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO2dCQUN2QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDakM7UUFDRCxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQztZQUM5QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQzs7WUFFckMsT0FBTyxPQUFPLElBQUksS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDMUQsQ0FBQztJQVVELElBQUksWUFBWTtRQUNaLE9BQU8sd0JBQXdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDakcsQ0FBQztJQUdELEdBQUcsQ0FBQyxHQUFXO1FBQ1gsSUFBSSxPQUFPLENBQUM7UUFDWixJQUFJLEdBQUcsRUFBRTtZQUNMLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFMUIsS0FBSyxJQUFJLE1BQU0sSUFBSSxJQUFJLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxPQUFPO29CQUNSLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7O29CQUV2QixPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2FBQ2hDO1NBQ0o7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVksRUFBRSxLQUFzQztRQUMvRCxJQUFJLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksSUFBSSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztZQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQ2xCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQztZQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsbUNBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUE2QixLQUFLLENBQUUsQ0FBQzs7WUFFakUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUN2QixnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0QsZ0JBQWdCLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxhQUFhLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFDekksQ0FBQztJQUVPLGtCQUFrQixDQUFDLFlBQWlCLEVBQUUsR0FBVztRQUNyRCxPQUFPLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0YsQ0FBQztJQUVPLE9BQU8sQ0FBQyxZQUFpQixFQUFFLElBQVksRUFBRSxTQUFpQjtRQUM5RCxJQUFJLEdBQUcsd0JBQXdCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDdkcsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDaEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDckMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxJQUFJLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFBO2dCQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNiLElBQUksSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQzVDLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUNuRCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUN0RCxDQUFDLENBQUMsQ0FBQTthQUNMO2lCQUFNO2dCQUNILElBQUksSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUM7Z0JBQy9DLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUN4QztTQUVKO1FBQ0QsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUNsQyxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUM1QyxJQUFJLElBQUksR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDZixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUM5RCxJQUFJLEdBQUcsSUFBSSxLQUFLLEVBQUU7b0JBQ2QsS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO29CQUN2QyxJQUFJLENBQUMsS0FBSzt3QkFDTixLQUFLLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7aUJBQ2hEO2dCQUNELElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQztvQkFDOUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUMzQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdDLENBQUMsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDbkM7O1lBQ0csSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDekMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNPYmplY3QgfSBmcm9tIFwiLi4vZnVuY3Rpb25zL2lzLW9iamVjdFwiO1xyXG5pbXBvcnQgeyBleHRyYWN0IH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9leHRyYWN0XCI7XHJcbmltcG9ydCB7IGdldFZhbHVlIH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9nZXQtdmFsdWVcIjtcclxuaW1wb3J0IHsgdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvdHJhbnNsYXRlLWNvbmZpZy1jb250YWluZXJcIjtcclxuaW1wb3J0IHsgZXF1YWxzIH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9lcXVhbHNcIjtcclxuaW1wb3J0IHsgTXVsdGlMaW5ndWFsRGF0YSB9IGZyb20gXCIuLi9jb3JlL211bHRpbGluZ3VhbC1kYXRhXCI7XHJcbmltcG9ydCB7IGdldEtleU5hbWUgfSBmcm9tIFwiLi4vZnVuY3Rpb25zL2dldC1rZXktbmFtZVwiO1xyXG5pbXBvcnQgeyBydW5QaXBlIH0gZnJvbSBcIi4uL2Z1bmN0aW9ucy9waXBlLnRyYW5zZm9ybWVyXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgVHJhbnNsYXRlTW9kZWwge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIHJhdzogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgcHJpdmF0ZSBjb21wb25lbnREYXRhOiBhbnksIHByaXZhdGUgbW9kZWxOYW1lLCBwcml2YXRlIHBhcmVudERhdGEpIHtcclxuICAgICAgICBsZXQgZGF0YSA9IHJhdztcclxuICAgICAgICBpZiAoZGF0YSlcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGtleSwge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgdGV4dCA9IGRhdGFba2V5XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KHRleHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShkYXRhW2tleV0gaW5zdGFuY2VvZiBUcmFuc2xhdGVNb2RlbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcERhdGEgPSBPYmplY3Qua2V5cyhwYXJlbnREYXRhKS5sZW5ndGggPT0gMCA/IGRhdGEgOiBwYXJlbnREYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmxvYWRpbmcpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBkYXRhW2tleV0gPSBuZXcgVHJhbnNsYXRlTW9kZWwoZGF0YVtrZXldLCBjb21wb25lbnREYXRhLCBtb2RlbE5hbWUsIHBEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVHJhbnNsYXRlTW9kZWwoZGF0YVtrZXldLCB7fSwgbW9kZWxOYW1lLCBwRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZGF0YVtrZXldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5sb2FkaW5nID8gXCJsb2FkaW5nLi4uXCIgOiB0aGlzLnRyYW5zZm9ybShkYXRhLCBrZXksIHRleHQpXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEtleVZhbHVlKGtleVBhcmFtT2JqZWN0OiBhbnkpIHtcclxuICAgICAgICBsZXQga2V5VmFsdWUgPSB7fTtcclxuICAgICAgICBPYmplY3Qua2V5cyhrZXlQYXJhbU9iamVjdCkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICBrZXlWYWx1ZVtrZXldID0gZ2V0VmFsdWUoa2V5LCB0aGlzLmNvbXBvbmVudERhdGEpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcmV0dXJuIGtleVZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdHJhbnNmb3JtKGRhdGEsIGtleSwgdGV4dCkge1xyXG4gICAgICAgIGlmICh0aGlzLnRoaXNQYXJhbWV0ZXJba2V5XSlcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGV4dChkYXRhLCB0ZXh0LCBrZXkpO1xyXG4gICAgICAgIGlmICh0aGlzLmtleVBhcmFtZXRlcnMgJiYgdGhpcy5rZXlQYXJhbWV0ZXJzW2tleV0gJiYgaXNPYmplY3QodGhpcy5rZXlQYXJhbWV0ZXJzW2tleV0pKSB7XHJcbiAgICAgICAgICAgIGlmICghZXF1YWxzKHRoaXMua2V5UGFyYW1ldGVyc1trZXldLCB0aGlzLmdldEtleVZhbHVlKHRoaXMua2V5UGFyYW1ldGVyc1trZXldKSkpXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUZXh0KGRhdGEsIHRleHQsIGtleSk7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMubWVtb2l6ZWRba2V5XSlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1lbW9pemVkW2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmtleVBhcmFtZXRlcnMgJiYgIXRoaXMua2V5UGFyYW1ldGVyc1trZXldKVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUZXh0KGRhdGEsIHRleHQsIGtleSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHRleHQgPT09IFwiZnVuY3Rpb25cIiA/IHRleHQoKSA6IHRleHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhY3RpdmVMYW5ndWFnZTogYW55O1xyXG5cclxuICAgIHByaXZhdGUga2V5UGFyYW1ldGVyczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgbWVtb2l6ZWQ6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcclxuXHJcbiAgICBwcml2YXRlIHRoaXNQYXJhbWV0ZXI6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9ID0ge307XHJcblxyXG4gICAgZ2V0IGxhbmd1YWdlQ29kZSgpIHtcclxuICAgICAgICByZXR1cm4gdHJhbnNsYXRlQ29uZmlnQ29udGFpbmVyLmNvbmZpZyA/IHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5jb25maWcubGFuZ3VhZ2VDb2RlIDogXCJlblwiO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXQoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgak9iamVjdDtcclxuICAgICAgICBpZiAoa2V5KSB7XHJcbiAgICAgICAgICAgIHZhciBrZXlzID0ga2V5LnNwbGl0KFwiLlwiKTtcclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IGNvbHVtbiBvZiBrZXlzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWpPYmplY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgak9iamVjdCA9IHRoaXNbY29sdW1uXTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICBqT2JqZWN0ID0gak9iamVjdFtjb2x1bW5dXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGpPYmplY3Q7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkT3JVcGRhdGVLZXkobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgeyBba2V5OiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgICAgIGxldCBrZXlOYW1lID0gZ2V0S2V5TmFtZSh0aGlzLm1vZGVsTmFtZSwgdGhpcy5sYW5ndWFnZUNvZGUsIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBNdWx0aUxpbmd1YWxEYXRhLmdldChrZXlOYW1lKTtcclxuICAgICAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSlcclxuICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlO1xyXG4gICAgICAgIGVsc2UgaWYgKGRhdGFbbmFtZV0pXHJcbiAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB7IC4uLmRhdGFbbmFtZV0sIC4uLjx7IFtrZXk6IHN0cmluZ106IGFueSB9PnZhbHVlIH07XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgTXVsdGlMaW5ndWFsRGF0YS5hZGRPclVwZGF0ZShrZXlOYW1lLCBkYXRhLCB0aGlzLmxhbmd1YWdlQ29kZSk7XHJcbiAgICAgICAgTXVsdGlMaW5ndWFsRGF0YS5yZW1vdmVDb21wb25lbnRQcm9wVmFsdWUodGhpcy5jb21wb25lbnREYXRhLmNvbnN0cnVjdG9yLCB0aGlzLmNvbXBvbmVudERhdGFbXCJfX25nQ29udGV4dF9fXCJdLnJ4UmVmTWFya2VkSWQsa2V5TmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBuZ3hUcmFuc2xhdGVQYXJzZXIodHJhbnNsYXRpb25zOiBhbnksIGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRyYW5zbGF0ZUNvbmZpZ0NvbnRhaW5lci5uZ3hUcmFuc2xhdGVbXCJnZXRQYXJzZWRSZXN1bHRcIl0odHJhbnNsYXRpb25zLCBrZXksIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VGV4dCh0cmFuc2xhdGlvbnM6IGFueSwgdGV4dDogc3RyaW5nLCBjb2x1bW5LZXk6IHN0cmluZykge1xyXG4gICAgICAgIHRleHQgPSB0cmFuc2xhdGVDb25maWdDb250YWluZXIubmd4VHJhbnNsYXRlID8gdGhpcy5uZ3hUcmFuc2xhdGVQYXJzZXIodHJhbnNsYXRpb25zLCBjb2x1bW5LZXkpIDogdGV4dDtcclxuICAgICAgICBpZiAodGV4dC5pbmRleE9mKCd0aGlzLicpICE9PSAtMSB8fCB0ZXh0LmluZGV4T2YoJ3t7e3RoaXMnKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgdGhpcy50aGlzUGFyYW1ldGVyW2NvbHVtbktleV0gPSB0cnVlO1xyXG4gICAgICAgICAgICBpZiAodGV4dC5pbmRleE9mKCd7e3t0aGlzJykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc3RyaW5nRXh0cmFjdG9yID0gZXh0cmFjdChbJ3t7eycsICd9fX0nXSk7XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5cyA9IHN0cmluZ0V4dHJhY3Rvcih0ZXh0KVxyXG4gICAgICAgICAgICAgICAga2V5cy5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmdW5jID0gbmV3IEZ1bmN0aW9uKFwieFwiLCBcInJldHVybiBcIiArIHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjYWxjdWxhdGVkVGV4dCA9IGZ1bmMuY2FsbCh0aGlzLmNvbXBvbmVudERhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoYHt7eyR7dH19fX1gLCBjYWxjdWxhdGVkVGV4dCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZ1bmMgPSBuZXcgRnVuY3Rpb24oXCJ4XCIsIFwicmV0dXJuIFwiICsgdGV4dCk7XHJcbiAgICAgICAgICAgICAgICB0ZXh0ID0gZnVuYy5jYWxsKHRoaXMuY29tcG9uZW50RGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0ZXh0ICYmIHRleHQuaW5kZXhPZihcInt7XCIpICE9IC0xKSB7XHJcbiAgICAgICAgICAgIGxldCBzdHJpbmdFeHRyYWN0b3IgPSBleHRyYWN0KFsne3snLCAnfX0nXSk7XHJcbiAgICAgICAgICAgIGxldCBrZXlzID0gc3RyaW5nRXh0cmFjdG9yKHRleHQpO1xyXG4gICAgICAgICAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHJ1blBpcGUoa2V5LCB0aGlzLmNvbXBvbmVudERhdGEsIHRoaXMucGFyZW50RGF0YSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBnZXRWYWx1ZShrZXksIHRoaXMucGFyZW50RGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBnZXRWYWx1ZShrZXksIHRoaXMuY29tcG9uZW50RGF0YSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5rZXlQYXJhbWV0ZXJzW2NvbHVtbktleV0pXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXlQYXJhbWV0ZXJzW2NvbHVtbktleV0gPSB7fTtcclxuICAgICAgICAgICAgICAgIHRoaXMua2V5UGFyYW1ldGVyc1tjb2x1bW5LZXldW2tleV0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoYHt7JHtrZXl9fX1gLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHRoaXMubWVtb2l6ZWRbY29sdW1uS2V5XSA9IHRleHQ7XHJcbiAgICAgICAgfSBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMua2V5UGFyYW1ldGVyc1tjb2x1bW5LZXldID0gdHJ1ZTtcclxuICAgICAgICByZXR1cm4gdGV4dDtcclxuICAgIH1cclxufVxyXG4iXX0=